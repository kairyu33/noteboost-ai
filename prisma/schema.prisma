// Prisma schema for note.com / codoc integration
// This schema supports access code-based authentication for note subscribers

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// アクセスコード管理
// note.comの有料購読者に配布するアクセスコード
model AccessCode {
  id        String   @id @default(cuid())
  code      String   @unique // アクセスコード（例: NOTE-ABC123-XYZ）

  // プラン情報
  plan      String   // 'free', 'basic', 'pro', 'unlimited'
  status    String   @default("active") // 'active', 'expired', 'revoked'

  // 使用制限
  monthlyLimit Int    @default(5) // 月間利用可能回数

  // 有効期限
  expiresAt DateTime? // NULL = 無期限

  // note.com連携情報（任意）
  noteUserId String?  // note.comのユーザーID（わかる場合）
  noteUrl    String?  // 購読元のnote記事URL

  // メタデータ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastUsedAt DateTime? // 最後に使用された日時

  // リレーション
  user      User?
  usageLogs UsageLog[]

  @@index([code])
  @@index([status])
}

// ユーザーセッション管理
// アクセスコードでログインしたユーザーの情報
model User {
  id            String   @id @default(cuid())

  // アクセスコード関連
  accessCodeId  String   @unique
  accessCode    AccessCode @relation(fields: [accessCodeId], references: [id], onDelete: Cascade)

  // ユーザー情報（任意）
  displayName   String?  // 表示名（noteのユーザー名など）
  email         String?  // メールアドレス（任意）

  // セッション管理
  sessionToken  String   @unique // JWTトークン

  // メタデータ
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime @default(now())

  // リレーション
  usageLogs     UsageLog[]

  @@index([sessionToken])
}

// API使用履歴
// 各ユーザーのAPI使用状況を記録
model UsageLog {
  id           String   @id @default(cuid())

  // ユーザー関連
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessCodeId String
  accessCode   AccessCode @relation(fields: [accessCodeId], references: [id], onDelete: Cascade)

  // 使用情報
  endpoint     String   // 'analyze-article-full'

  // トークン使用量
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  totalTokens  Int      @default(0)

  // キャッシュ情報
  cacheHit     Boolean  @default(false)

  // コスト情報（USD）
  cost         Float    @default(0)

  // 記事情報
  articleLength Int?    // 分析した記事の文字数

  // メタデータ
  createdAt    DateTime @default(now())

  // 月次集計用インデックス
  @@index([userId, createdAt])
  @@index([accessCodeId, createdAt])
}

// 管理者用テーブル（将来拡張用）
model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // ハッシュ化されたパスワード
  role      String   @default("admin") // 'admin', 'super_admin'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
